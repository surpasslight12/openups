# OpenUPS C - AI Context & Coding Standards

## 项目概述

**OpenUPS C** 是一个轻量级、高性能的 Linux 网络监控工具，使用 C23 标准编写。

### 核心特性
- 原生 ICMP ping 实现（IPv4/IPv6）
- systemd 深度集成（sd_notify、watchdog）
- 极致性能优化（C23 + LTO + 原生优化）
- 高安全性（10/10 评级）
- 零第三方依赖

### 项目架构
```
src/
├── main.c         # 程序入口、信号处理
├── common.c/h     # 通用工具函数（时间戳、字符串处理）
├── config.c/h     # 配置管理（CLI + 环境变量）
├── logger.c/h     # 日志系统（5 级日志 + syslog）
├── icmp.c/h       # ICMP ping 实现
├── systemd.c/h    # systemd 集成
└── monitor.c/h    # 监控核心逻辑
```

## 编码规范

### C 语言标准
- **标准**: C23 (C2x)
- **编译器**: GCC 14.2+
- **优化**: -O3 -flto -march=native -mtune=native

### 命名约定
```c
// 结构体类型使用 _t 后缀
typedef struct {
    int value;
} config_t;

// 枚举类型使用 _t 后缀，大写字母
typedef enum {
    LOG_LEVEL_SILENT = -1,
    LOG_LEVEL_ERROR = 0,
    LOG_LEVEL_WARN = 1,
    LOG_LEVEL_INFO = 2,
    LOG_LEVEL_DEBUG = 3
} log_level_t;

// 函数名使用 module_action 格式
void logger_init(logger_t* logger, log_level_t level, ...);
void config_load_from_env(config_t* config);

// 静态函数使用 static
static int level_to_syslog_priority(log_level_t level) { ... }

// 常量使用大写字母
#define MAX_PATH_LENGTH 4096
#define PROGRAM_NAME "openups"
```

### 代码风格
```c
// 1. 缩进：4 空格
// 2. 大括号：函数定义另起一行，其他紧跟
void function_name(void) {
    if (condition) {
        // code
    } else {
        // code
    }
}

// 3. 指针声明：星号靠近类型
int* ptr;
config_t* config;

// 4. 布尔类型：使用 bool (stdbool.h)
bool is_valid = true;

// 5. 注释：使用 /* */ 或 //
/* 多行注释 */
// 单行注释
```

### 安全编码规范

#### 1. 字符串操作
```c
// ✅ 推荐：使用 snprintf
snprintf(buffer, sizeof(buffer), "%s", source);

// ❌ 避免：strcpy, strcat
strcpy(buffer, source);  // 不安全
```

#### 2. 内存管理
```c
// ✅ 始终检查分配结果
void* ptr = malloc(size);
if (!ptr) {
    logger_error(logger, "Memory allocation failed");
    return false;
}

// ✅ 使用后释放
free(ptr);
ptr = NULL;
```

#### 3. 整数溢出
```c
// ✅ 检查边界
if (packet_size < 0 || packet_size > 65507) {
    snprintf(error_msg, error_size, "Packet size out of range");
    return false;
}
```

#### 4. 路径验证
```c
// ✅ 验证路径安全性
static bool is_safe_path(const char* path) {
    if (strstr(path, "..") || strstr(path, "//") || 
        strchr(path, ';') || strchr(path, '|') || 
        strchr(path, '&') || strchr(path, '`')) {
        return false;
    }
    return true;
}
```

### 日志系统使用

#### 日志级别（v1.1.0 更新）
```c
// 5 个日志级别
LOG_LEVEL_SILENT = -1,  // 完全静默
LOG_LEVEL_ERROR = 0,    // 仅错误
LOG_LEVEL_WARN = 1,     // 警告 + 错误
LOG_LEVEL_INFO = 2,     // 信息 + 警告 + 错误（默认）
LOG_LEVEL_DEBUG = 3     // 所有日志 + 详细输出

// ✅ 使用统一的日志接口（printf 风格）
logger_debug(logger, "Debug message: value=%d", 123);
logger_info(logger, "Info message: target=%s", "1.1.1.1");
logger_warn(logger, "Warning message: count=%d", 5);
logger_error(logger, "Error message: %s", strerror(errno));

// ✅ 自然语序日志（不使用 key=value 格式）
logger_info(logger, "Starting monitor: target=%s interval=%ds threshold=%d",
            "1.1.1.1", 10, 5);
```

#### systemd journald 集成
```c
// ✅ systemd 环境下禁用程序时间戳
Environment="OPENUPS_NO_TIMESTAMP=true"

// 日志输出格式
// journald: Oct 26 22:37:19 host openups[36631]: [INFO] message
// console:  [2025-10-26 22:37:19.123] [INFO] message
```

### systemd 集成

#### 服务通知
```c
#include "systemd.h"

// 初始化
systemd_t systemd;
systemd_init(&systemd);

// 通知就绪
systemd_notify_ready(&systemd);

// 更新状态
systemd_notify_status(&systemd, "Monitoring target=1.1.1.1");

// 发送 watchdog
systemd_notify_watchdog(&systemd);
```

### 错误处理

```c
// ✅ 函数返回 bool 表示成功/失败
bool config_validate(const config_t* config, char* error_msg, size_t error_size) {
    if (strlen(config->target) == 0) {
        snprintf(error_msg, error_size, "Target cannot be empty");
        return false;
    }
    return true;
}

// ✅ 调用时检查返回值
char error_msg[256];
if (!config_validate(&config, error_msg, sizeof(error_msg))) {
    logger_error(&logger, error_msg);
    return EXIT_FAILURE;
}
```

## 编译与测试

### 编译
```bash
# 完整编译（包含所有优化和安全标志）
make

# 清理
make clean
```

### 测试
```bash
# 基本测试
sudo ./bin/openups --target 1.1.1.1 --interval 1 --threshold 3 --dry-run --log-level debug

# 授予 capability 后测试
sudo setcap cap_net_raw+ep ./bin/openups
./bin/openups --target 1.1.1.1 --interval 1 --threshold 3 --dry-run
```

### 自动化测试
```bash
./test.sh
```

## 性能优化

### 编译器优化
- **-O3**: 最高级别优化
- **-flto**: 链接时优化
- **-march=native**: CPU 原生指令集
- **-mtune=native**: CPU 调优

### 代码优化
```c
// ✅ 使用 const 优化
void process_config(const config_t* config);

// ✅ 内联小函数（让编译器决定）
static inline bool is_valid_level(log_level_t level) {
    return level >= LOG_LEVEL_SILENT && level <= LOG_LEVEL_DEBUG;
}

// ✅ 避免不必要的内存分配
// 使用栈上的固定大小缓冲区而非 malloc
char buffer[256];
```

## 安全清单

- [x] Full RELRO
- [x] PIE
- [x] Stack Canary
- [x] NX Stack
- [x] FORTIFY_SOURCE=3
- [x] 所有字符串操作使用 snprintf
- [x] 路径验证（防止遍历攻击）
- [x] 命令注入防护
- [x] 整数溢出检查
- [x] 内存分配失败处理

## Git 提交规范

```
<type>(<scope>): <subject>

<body>

<footer>
```

### Type
- **feat**: 新功能
- **fix**: 修复 bug
- **docs**: 文档更新
- **style**: 代码格式（不影响功能）
- **refactor**: 重构
- **perf**: 性能优化
- **test**: 测试相关
- **chore**: 构建/工具链

### 示例
```
feat(logger): 简化日志系统参数

- 移除 -v/--verbose 和 -q/--quiet 别名
- 统一使用 --log-level 参数
- 新增 SILENT 日志级别
- 更新所有文档

Closes #123
```

## 最新更新 (v1.1.0)

### 日志系统简化
- **移除**: `-v/--verbose`, `-q/--quiet` 别名
- **统一**: 使用 `--log-level` 参数（silent|error|warn|info|debug）
- **新增**: `LOG_LEVEL_SILENT` 静默模式
- **优化**: 移除 `verbose` 字段，统一使用 `log_level`

### systemd journald 集成
- **新增**: `OPENUPS_NO_TIMESTAMP` 环境变量
- **优化**: systemd 环境下自动禁用程序时间戳
- **效果**: 避免双重时间戳，日志输出更简洁
- **推荐**: systemd 服务使用 `Environment="OPENUPS_NO_TIMESTAMP=true"`

### 性能提升
- **C23 标准**: 使用最新 C 语言特性
- **二进制优化**: 45KB → 39KB (-13%)
- **LTO**: 链接时优化
- **原生优化**: -march=native -mtune=native

## AI 提示

### 代码修改时
1. 遵循 C23 标准和项目编码规范
2. 使用安全的字符串函数（snprintf）
3. 添加必要的错误检查和边界检查
4. 保持代码简洁、可读
5. 添加适当的注释

### 文档更新时
1. 同步更新所有相关文档（README、QUICKSTART、ARCHITECTURE）
2. 使用清晰的 Markdown 格式
3. 保持中英文术语一致性
4. 添加代码示例和使用场景

### 测试时
1. 测试所有日志级别
2. 验证 systemd 集成
3. 检查编译警告（应为 0）
4. 运行自动化测试脚本

---

**版本**: v1.1.0
**更新日期**: 2025-10-26
**维护者**: surpasslight12
